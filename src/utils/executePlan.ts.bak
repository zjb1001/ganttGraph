/**
 * Execute LLM-generated ExecutionPlan
 * This module executes the concrete data modifications generated by the LLM
 */

import { useAppStore } from '@/store/appStore';
import type { ExecutionPlan, TaskModification, MilestoneCreation, BucketModification } from './agentApi';

/**
 * Execute a single task modification
 */
async function executeTaskModification(mod: TaskModification): Promise<string> {
  const store = useAppStore.getState();

  switch (mod.operation) {
    case 'create': {
      await store.addTask({
        title: mod.title || 'New Task',
        startDateTime: mod.startDateTime || new Date().toISOString(),
        dueDateTime: mod.dueDateTime || new Date().toISOString(),
        status: mod.status || 'notStarted',
        priority: mod.priority || 'normal',
        completedPercent: mod.progress || 0,
        bucketId: mod.bucketId
      });
      return `Created task: ${mod.title}`;
    }

    case 'update': {
      if (!mod.id) {
        return `Error: Task ID required for update`;
      }
      const task = store.tasks.find(t => t.id === mod.id);
      if (!task) {
        return `Error: Task ${mod.id} not found`;
      }

      const updates: any = {};
      if (mod.title !== undefined) updates.title = mod.title;
      if (mod.startDateTime !== undefined) updates.startDateTime = mod.startDateTime;
      if (mod.dueDateTime !== undefined) updates.dueDateTime = mod.dueDateTime;
      if (mod.status !== undefined) updates.status = mod.status;
      if (mod.priority !== undefined) updates.priority = mod.priority;
      if (mod.progress !== undefined) updates.completedPercent = mod.progress;
      if (mod.bucketId !== undefined) updates.bucketId = mod.bucketId;

      await store.updateTask(mod.id, updates);
      return `Updated task: ${mod.title || task.title}`;
    }

    case 'delete': {
      if (!mod.id) {
        return `Error: Task ID required for deletion`;
      }
      const task = store.tasks.find(t => t.id === mod.id);
      if (!task) {
        return `Error: Task ${mod.id} not found`;
      }
      await store.deleteTask(mod.id);
      return `Deleted task: ${task.title}`;
    }

    default:
      return `Unknown operation: ${mod.operation}`;
  }
}

/**
 * Execute a single milestone creation
 */
async function executeMilestoneCreation(mod: MilestoneCreation): Promise<string> {
  const store = useAppStore.getState();

  // Create or find milestone bucket
  let bucketId = mod.bucketId;
  if (!bucketId) {
    // Find or create default milestone bucket
    let milestoneBucket = store.buckets.find(b => b.bucketType === 'milestone');
    if (!milestoneBucket) {
      milestoneBucket = await store.addBucket({
        name: 'Milestones',
        color: '#8b5cf6',
        bucketType: 'milestone'
      });
    }
    bucketId = milestoneBucket.id;
  }

  // Create milestone as a task
  await store.addTask({
    title: mod.title,
    startDateTime: mod.date,
    dueDateTime: mod.date,
    status: 'completed',
    priority: 'high',
    completedPercent: 100,
    bucketId: bucketId,
    taskType: 'milestone'
  });

  return `Created milestone: ${mod.title} on ${mod.date}`;
}

/**
 * Execute a single bucket modification
 */
async function executeBucketModification(mod: BucketModification): Promise<string> {
  const store = useAppStore.getState();

  switch (mod.operation) {
    case 'create': {
      await store.addBucket({
        name: mod.name || 'New Bucket',
        color: mod.color || '#3b82f6',
        bucketType: mod.bucketType || 'task'
      });
      return `Created ${mod.bucketType || 'task'} bucket: ${mod.name}`;
    }

    case 'update': {
      if (!mod.id) {
        return `Error: Bucket ID required for update`;
      }
      const bucket = store.buckets.find(b => b.id === mod.id);
      if (!bucket) {
        return `Error: Bucket ${mod.id} not found`;
      }

      const updates: any = {};
      if (mod.name !== undefined) updates.name = mod.name;
      if (mod.color !== undefined) updates.color = mod.color;
      if (mod.bucketType !== undefined) updates.bucketType = mod.bucketType;

      await store.updateBucket(mod.id, updates);
      return `Updated bucket: ${mod.name || bucket.name}`;
    }

    case 'delete': {
      if (!mod.id) {
        return `Error: Bucket ID required for deletion`;
      }
      const bucket = store.buckets.find(b => b.id === mod.id);
      if (!bucket) {
        return `Error: Bucket ${mod.id} not found`;
      }
      await store.deleteBucket(mod.id);
      return `Deleted bucket: ${bucket.name}`;
    }

    default:
      return `Unknown operation: ${mod.operation}`;
  }
}

/**
 * Execute the complete ExecutionPlan
 * Executes modifications in order: buckets -> tasks -> milestones
 */
export async function executeExecutionPlan(plan: ExecutionPlan): Promise<string[]> {
  const results: string[] = [];

  // Execute bucket modifications first
  for (const bucketMod of plan.bucketModifications) {
    const result = await executeBucketModification(bucketMod);
    results.push(result);
  }

  // Execute task modifications
  for (const taskMod of plan.taskModifications) {
    const result = await executeTaskModification(taskMod);
    results.push(result);
  }

  // Execute milestone creations
  for (const milestone of plan.milestoneCreations) {
    const result = await executeMilestoneCreation(milestone);
    results.push(result);
  }

  return results;
}
